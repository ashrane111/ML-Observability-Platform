# =============================================================================
# AlertManager Configuration
# =============================================================================

global:
  # How long to wait before sending a notification again
  resolve_timeout: 5m

# Route configuration
route:
  # Default receiver
  receiver: 'default-receiver'
  
  # Group alerts by these labels
  group_by: ['alertname', 'category', 'model_name']
  
  # How long to initially wait before sending notification
  group_wait: 30s
  
  # How long to wait before sending notification about new alerts in group
  group_interval: 5m
  
  # How long to wait before sending a repeated notification
  repeat_interval: 4h

  # Child routes for different alert types
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h

    # Drift alerts - group together
    - match:
        category: drift
      receiver: 'drift-receiver'
      group_by: ['alertname', 'model_name']
      group_wait: 1m

    # Performance alerts
    - match:
        category: performance
      receiver: 'performance-receiver'
      group_wait: 2m

    # Data quality alerts
    - match:
        category: data_quality
      receiver: 'data-quality-receiver'
      group_wait: 1m

# Inhibition rules - suppress certain alerts when others are firing
inhibit_rules:
  # If critical alert is firing, suppress warnings for same model
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'model_name']

  # If service is down, suppress performance alerts
  - source_match:
      alertname: 'APIServiceDown'
    target_match:
      category: 'performance'
    equal: ['job']

# Receivers - where to send alerts
receivers:
  # Default receiver - logs to console (for demo)
  - name: 'default-receiver'
    webhook_configs:
      - url: 'http://api:8000/webhooks/alerts'
        send_resolved: true

  # Critical alerts receiver
  - name: 'critical-receiver'
    webhook_configs:
      - url: 'http://api:8000/webhooks/alerts/critical'
        send_resolved: true
    # Uncomment to add Slack notification
    # slack_configs:
    #   - api_url: 'YOUR_SLACK_WEBHOOK_URL'
    #     channel: '#ml-alerts-critical'
    #     send_resolved: true
    #     title: '{{ .Status | toUpper }}: {{ .CommonAnnotations.summary }}'
    #     text: '{{ .CommonAnnotations.description }}'

  # Drift alerts receiver
  - name: 'drift-receiver'
    webhook_configs:
      - url: 'http://api:8000/webhooks/alerts/drift'
        send_resolved: true

  # Performance alerts receiver
  - name: 'performance-receiver'
    webhook_configs:
      - url: 'http://api:8000/webhooks/alerts/performance'
        send_resolved: true

  # Data quality alerts receiver
  - name: 'data-quality-receiver'
    webhook_configs:
      - url: 'http://api:8000/webhooks/alerts/data-quality'
        send_resolved: true

# Templates for notifications (optional)
# templates:
#   - '/etc/alertmanager/templates/*.tmpl'
