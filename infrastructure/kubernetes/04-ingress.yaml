# ML Observability Platform - Ingress Configuration
# ==================================================

# Ingress for external access (requires Ingress Controller)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ml-observability-ingress
  namespace: ml-observability
  labels:
    app.kubernetes.io/name: ml-observability-platform
  annotations:
    # NGINX Ingress Controller annotations
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "120"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "120"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
    # SSL redirect (enable when TLS is configured)
    # nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx  # Adjust for your cluster
  rules:
    # ML API
    - host: ml-api.example.com  # Change to your domain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ml-api
                port:
                  number: 8000

    # Grafana
    - host: grafana.example.com  # Change to your domain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000

    # Jaeger UI
    - host: jaeger.example.com  # Change to your domain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: jaeger-query
                port:
                  number: 16686

    # Prometheus (typically internal only)
    - host: prometheus.example.com  # Change to your domain
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus
                port:
                  number: 9090

  # TLS configuration (uncomment and configure for HTTPS)
  # tls:
  #   - hosts:
  #       - ml-api.example.com
  #       - grafana.example.com
  #       - jaeger.example.com
  #     secretName: ml-observability-tls

---
# Alternative: NodePort services for local/development clusters
# Uncomment if not using Ingress

# apiVersion: v1
# kind: Service
# metadata:
#   name: ml-api-nodeport
#   namespace: ml-observability
# spec:
#   type: NodePort
#   ports:
#     - port: 8000
#       targetPort: 8000
#       nodePort: 30800
#   selector:
#     app: ml-api

# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: grafana-nodeport
#   namespace: ml-observability
# spec:
#   type: NodePort
#   ports:
#     - port: 3000
#       targetPort: 3000
#       nodePort: 30300
#   selector:
#     app: grafana

# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: jaeger-nodeport
#   namespace: ml-observability
# spec:
#   type: NodePort
#   ports:
#     - port: 16686
#       targetPort: 16686
#       nodePort: 31686
#   selector:
#     app: jaeger

---
# NetworkPolicy for security
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ml-api-network-policy
  namespace: ml-observability
spec:
  podSelector:
    matchLabels:
      app: ml-api
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - port: 8000
    # Allow Prometheus scraping
    - from:
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - port: 8000
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
    # Allow Jaeger
    - to:
        - podSelector:
            matchLabels:
              app: jaeger
      ports:
        - port: 4317
        - port: 14268
    # Allow external traffic (for any external APIs)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - port: 443
        - port: 80
